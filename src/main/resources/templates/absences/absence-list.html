<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css" rel="stylesheet">
    <title>Absence Journal</title>
    <style>
        .table-column-hidden {
            display: none !important;
        }
    </style>
</head>
<body>

<div class="container">

    <div class="d-flex justify-content-between align-items-center mb-4 mt-4">
        <h3>Absence Journal</h3>
        <div>
            <a th:href="@{/absences/add}" class="btn btn-primary btn-sm me-2">Add Absence</a>
            <a th:href="@{/employees}" class="btn btn-outline-secondary btn-sm me-2">Employees</a>
            <a th:href="@{/departments}" class="btn btn-outline-info btn-sm">Departments</a>
        </div>
    </div>

    <form th:action="@{/absences}" method="get" class="row g-2 mb-3 p-2 bg-light border rounded">
        <div class="col-md-4">
            <input type="text" name="q" class="form-control form-control-sm" placeholder="Search employee name..."
                   th:value="${currentSearch}" aria-label="Search"/>
        </div>

        <div class="col-md-3">
            <select name="type" class="form-select form-select-sm">
                <option value="">All Types</option>
                <option th:each="t : ${types}" th:value="${t}" th:text="${t}" th:selected="${t == currentType}"></option>
            </select>
        </div>

        <div class="col-auto">
            <button type="submit" class="btn btn-outline-primary btn-sm">Apply</button>
            <a th:href="@{/absences}" class="btn btn-outline-secondary btn-sm">Clear</a>
        </div>

        <input type="hidden" name="sort" th:value="${param.sort != null ? param.sort[0] : ''}"/>
        <input type="hidden" name="size" th:value="${absences.size}"/>
    </form>

    <div class="mb-3">
        <div class="dropdown d-inline-block">
            <button class="btn btn-outline-secondary btn-sm dropdown-toggle" type="button" id="colVisBtn" data-bs-toggle="dropdown" aria-expanded="false">
                Visible Columns
            </button>
            <ul class="dropdown-menu p-2">
                <li class="form-check">
                    <input class="form-check-input js-column-toggle" type="checkbox" value="empName" id="c1" checked disabled>
                    <label class="form-check-label" for="c1">Employee Name</label>
                </li>
                <li class="form-check">
                    <input class="form-check-input js-column-toggle" type="checkbox" value="type" id="c2" checked>
                    <label class="form-check-label" for="c2">Type</label>
                </li>
                <li class="form-check">
                    <input class="form-check-input js-column-toggle" type="checkbox" value="dates" id="c3" checked>
                    <label class="form-check-label" for="c3">Dates</label>
                </li>
                <li class="form-check">
                    <input class="form-check-input js-column-toggle" type="checkbox" value="sickPay" id="c4">
                    <label class="form-check-label" for="c4">Sick Pay (Calc)</label>
                </li>
            </ul>
        </div>
    </div>

    <table class="table table-bordered table-striped table-hover">
        <thead class="table-dark">
        <tr>
            <th data-column-id="empName" class="js-column-cell"
                th:with="cs=${param.sort != null ? param.sort[0] : ''},
                           isActive=${#strings.startsWith(cs,'employeeFirstName,')},
                           isDesc=${isActive ? #strings.contains(cs,',desc') : false},
                           nextDir=${(isActive and not isDesc) ? 'desc' : 'asc'}">
                <a th:href="@{/absences(sort=${'employeeFirstName,' + nextDir}, size=${absences.size}, q=${currentSearch}, type=${currentType})}"
                   class="link-light text-decoration-none">
                    Employee Name <span th:text="${isActive} ? (${isDesc} ? '↓' : '↑') : ''"></span>
                </a>
            </th>

            <th data-column-id="type" class="js-column-cell"
                th:with="cs=${param.sort != null ? param.sort[0] : ''},
                           isActive=${#strings.startsWith(cs,'type,')},
                           isDesc=${isActive ? #strings.contains(cs,',desc') : false},
                           nextDir=${(isActive and not isDesc) ? 'desc' : 'asc'}">
                <a th:href="@{/absences(sort=${'type,' + nextDir}, size=${absences.size}, q=${currentSearch}, type=${currentType})}"
                   class="link-light text-decoration-none">
                    Type <span th:text="${isActive} ? (${isDesc} ? '↓' : '↑') : ''"></span>
                </a>
            </th>

            <th data-column-id="dates" class="js-column-cell"
                th:with="cs=${param.sort != null ? param.sort[0] : ''},
                           isActive=${#strings.startsWith(cs,'startDate,')},
                           isDesc=${isActive ? #strings.contains(cs,',desc') : false},
                           nextDir=${(isActive and not isDesc) ? 'desc' : 'asc'}">
                <a th:href="@{/absences(sort=${'startDate,' + nextDir}, size=${absences.size}, q=${currentSearch}, type=${currentType})}"
                   class="link-light text-decoration-none">
                    Start Date <span th:text="${isActive} ? (${isDesc} ? '↓' : '↑') : ''"></span>
                </a>
            </th>

            <th data-column-id="dates" class="js-column-cell"
                th:with="cs=${param.sort != null ? param.sort[0] : ''},
                           isActive=${#strings.startsWith(cs,'endDate,')},
                           isDesc=${isActive ? #strings.contains(cs,',desc') : false},
                           nextDir=${(isActive and not isDesc) ? 'desc' : 'asc'}">
                <a th:href="@{/absences(sort=${'endDate,' + nextDir}, size=${absences.size}, q=${currentSearch}, type=${currentType})}"
                   class="link-light text-decoration-none">
                    End Date <span th:text="${isActive} ? (${isDesc} ? '↓' : '↑') : ''"></span>
                </a>
            </th>

            <th data-column-id="sickPay" class="js-column-cell"
                th:with="cs=${param.sort != null ? param.sort[0] : ''},
                           isActive=${#strings.startsWith(cs,'sickPay,')},
                           isDesc=${isActive ? #strings.contains(cs,',desc') : false},
                           nextDir=${(isActive and not isDesc) ? 'desc' : 'asc'}">
                <a th:href="@{/absences(sort=${'sickPay,' + nextDir}, size=${absences.size}, q=${currentSearch}, type=${currentType})}"
                   class="link-light text-decoration-none">
                    Sick Pay
                    <span th:text="${isActive} ? (${isDesc} ? '↓' : '↑') : ''"></span>
                </a>
            </th>

            <th style="width: 220px;">Actions</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="a : ${absences.content}">
            <td data-column-id="empName" class="js-column-cell">
                <span th:text="${a.employeeFirstName} + ' ' + ${a.employeeLastName}" class="fw-bold">Name</span>
            </td>
            <td data-column-id="type" class="js-column-cell">
                <span th:class="${'badge ' +
                    (a.type.name() == 'VACATION' ? 'text-bg-success' :
                    (a.type.name() == 'SICK_LEAVE' ? 'text-bg-danger' : 'text-bg-warning'))}"
                      th:text="${a.type}">TYPE</span>
            </td>
            <td data-column-id="dates" class="js-column-cell" th:text="${a.startDate}">Start</td>
            <td data-column-id="dates" class="js-column-cell" th:text="${a.endDate}">End</td>

            <td data-column-id="sickPay" class="js-column-cell">
                <span th:if="${a.sickPay > 0}" th:text="${a.sickPay}" class="text-success fw-bold"></span>
                <span th:unless="${a.sickPay > 0}" class="text-muted">-</span>
            </td>

            <td class="d-flex gap-2">
                <a th:href="@{/absences/update(id=${a.id})}" class="btn btn-sm btn-info">Update</a>
                <a th:href="@{/absences/delete(id=${a.id})}" class="btn btn-sm btn-danger"
                   onclick="return confirm('Delete this record?')">Delete</a>
                <a th:href="@{/absences/{id}(id=${a.id})}" class="btn btn-sm btn-outline-primary">View</a>
            </td>
        </tr>
        <tr th:if="${absences.empty}">
            <td colspan="6" class="text-center text-muted">No absence records found.</td>
        </tr>
        </tbody>
    </table>

    <div class="d-flex flex-wrap align-items-center justify-content-between gap-2 mb-3" th:if="${absences.totalPages > 0}">
        <div class="btn-group" role="group">
            <a th:if="${absences.hasPrevious()}" class="btn btn-outline-secondary btn-sm"
               th:href="@{/absences(page=${absences.number - 1}, size=${absences.size}, sort=${param.sort != null ? param.sort[0] : null}, q=${currentSearch}, type=${currentType})}">Previous</a>
            <span th:unless="${absences.hasPrevious()}" class="btn btn-outline-secondary btn-sm disabled">Previous</span>
            <a th:if="${absences.hasNext()}" class="btn btn-outline-secondary btn-sm"
               th:href="@{/absences(page=${absences.number + 1}, size=${absences.size}, sort=${param.sort != null ? param.sort[0] : null}, q=${currentSearch}, type=${currentType})}">Next</a>
            <span th:unless="${absences.hasNext()}" class="btn btn-outline-secondary btn-sm disabled">Next</span>
        </div>
        <div>Page <span th:text="${absences.number + 1}"></span> of <span th:text="${absences.totalPages}"></span></div>
        <form th:action="@{/absences}" method="get" class="d-flex align-items-center gap-2">
            <select name="size" class="form-select form-select-sm" onchange="this.form.submit()" style="width: auto;">
                <option th:value="10" th:selected="${absences.size == 10}">10</option>
                <option th:value="20" th:selected="${absences.size == 20}">20</option>
                <option th:value="50" th:selected="${absences.size == 50}">50</option>
            </select>
            <input type="hidden" name="page" value="0">
            <input type="hidden" name="sort" th:if="${param.sort != null}" th:value="${param.sort[0]}">
            <input type="hidden" name="q" th:value="${currentSearch}">
            <input type="hidden" name="type" th:value="${currentType}">
        </form>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // Скрипт для видимості колонок (Зберігає вибір у localStorage)
    (function () {
        const STORAGE_KEY = 'absenceTableCols';

        function applyVisibility() {
            document.querySelectorAll('.js-column-toggle').forEach(cb => {
                const colId = cb.value;
                const isVisible = cb.checked;
                document.querySelectorAll(`.js-column-cell[data-column-id="${colId}"]`).forEach(cell => {
                    if (isVisible) cell.classList.remove('table-column-hidden');
                    else cell.classList.add('table-column-hidden');
                });
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            // 1. Відновити стан з LocalStorage
            const stored = localStorage.getItem(STORAGE_KEY);
            if (stored) {
                try {
                    const checkedValues = JSON.parse(stored);
                    document.querySelectorAll('.js-column-toggle').forEach(cb => {
                        if (cb.value !== 'empName') { // empName завжди on
                            cb.checked = checkedValues.includes(cb.value);
                        }
                    });
                } catch(e) {}
            }

            // 2. Застосувати видимість
            applyVisibility();

            // 3. Слухати зміни
            document.querySelectorAll('.js-column-toggle').forEach(cb => {
                cb.addEventListener('change', () => {
                    applyVisibility();
                    // Зберегти
                    const checked = Array.from(document.querySelectorAll('.js-column-toggle:checked')).map(c => c.value);
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(checked));
                });
            });
        });
    })();
</script>
</body>
</html>