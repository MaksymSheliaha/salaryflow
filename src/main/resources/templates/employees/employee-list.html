<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css" rel="stylesheet">
    <title>Employee Directory</title>
    <style>
        .table-column-hidden {
            display: none !important;
        }
    </style>
</head>
<body>

<div th:replace="~{fragments/header :: navbar}"></div>

<div class="container">

    <div class="d-flex justify-content-between align-items-center mb-3">
        <h3>Employee Directory</h3>
        <a th:href="@{/employees/add}" class="btn btn-primary btn-sm">
            Add Employee
        </a>
    </div>

    <form th:action="@{/employees}" method="get" class="row g-2 mb-3 bg-light p-2 rounded border">
        <input type="hidden" name="size" th:value="${page.size}">
        <input type="hidden" name="sort" th:if="${param.sort != null}" th:value="${param.sort[0]}">

        <div class="col-md-3">
            <input type="text" name="q" class="form-control form-control-sm"
                   placeholder="Search name or email..." th:value="${currentSearch}">
        </div>

        <div class="col-md-3">
            <select name="deptId" class="form-select form-select-sm">
                <option value="">All Departments</option>
                <option th:each="dept : ${departmentList}"
                        th:value="${dept.id}"
                        th:text="${dept.name}"
                        th:selected="${dept.id == currentDeptId}"></option>
            </select>
        </div>

        <div class="col-md-3">
            <select name="pos" class="form-select form-select-sm">
                <option value="">All Positions</option>
                <option th:each="pos : ${positionList}"
                        th:value="${pos}"
                        th:text="${pos}"
                        th:selected="${pos == currentPos}"></option>
            </select>
        </div>

        <div class="col-md-3 d-flex gap-2">
            <button type="submit" class="btn btn-sm btn-primary w-50">Filter</button>
            <a th:href="@{/employees}" class="btn btn-sm btn-outline-secondary w-50">Clear</a>
        </div>
    </form>

    <div class="mb-3">
        <div class="dropdown d-inline-block">
            <button class="btn btn-outline-secondary btn-sm dropdown-toggle" type="button" id="colVisBtn" data-bs-toggle="dropdown" aria-expanded="false">
                Visible Columns
            </button>
            <ul class="dropdown-menu p-2">
                <li class="form-check">
                    <input class="form-check-input js-column-toggle" type="checkbox" value="lastName" id="c1" checked disabled>
                    <label class="form-check-label" for="c1">Last Name (Always)</label>
                </li>
                <li class="form-check">
                    <input class="form-check-input js-column-toggle" type="checkbox" value="firstName" id="c2" checked>
                    <label class="form-check-label" for="c2">First Name</label>
                </li>
                <li class="form-check">
                    <input class="form-check-input js-column-toggle" type="checkbox" value="email" id="c3" checked>
                    <label class="form-check-label" for="c3">Email</label>
                </li>
                <li class="form-check">
                    <input class="form-check-input js-column-toggle" type="checkbox" value="position" id="c4" checked>
                    <label class="form-check-label" for="c4">Position</label>
                </li>
                <li class="form-check">
                    <input class="form-check-input js-column-toggle" type="checkbox" value="salary" id="c5" checked>
                    <label class="form-check-label" for="c5">Salary</label>
                </li>
                <li class="form-check">
                    <input class="form-check-input js-column-toggle" type="checkbox" value="department" id="c6" checked>
                    <label class="form-check-label" for="c6">Department</label>
                </li>
                <li class="form-check">
                    <input class="form-check-input js-column-toggle" type="checkbox" value="hireDate" id="c7" checked>
                    <label class="form-check-label" for="c7">Hire Date</label>
                </li>
            </ul>
        </div>
    </div>

    <table class="table table-bordered table-striped table-hover">
        <thead class="table-dark">
        <tr>
            <th data-column-id="lastName" class="js-column-cell"
                th:with="sortCol='lastName',
                         currSort=${param.sort != null ? param.sort[0] : ''},
                         isAsc=${currSort.contains(sortCol + ',asc')},
                         newDir=${isAsc ? 'desc' : 'asc'}">
                <a th:href="@{/employees(page=${page.number}, size=${page.size}, q=${currentSearch}, deptId=${currentDeptId}, pos=${currentPos}, sort=${sortCol + ',' + newDir})}"
                   class="text-white text-decoration-none d-block">
                    Last Name <span th:if="${currSort.contains(sortCol)}" th:text="${isAsc ? '↑' : '↓'}"></span>
                </a>
            </th>

            <th data-column-id="firstName" class="js-column-cell"
                th:with="sortCol='firstName',
                         currSort=${param.sort != null ? param.sort[0] : ''},
                         isAsc=${currSort.contains(sortCol + ',asc')},
                         newDir=${isAsc ? 'desc' : 'asc'}">
                <a th:href="@{/employees(page=${page.number}, size=${page.size}, q=${currentSearch}, deptId=${currentDeptId}, pos=${currentPos}, sort=${sortCol + ',' + newDir})}"
                   class="text-white text-decoration-none d-block">
                    First Name <span th:if="${currSort.contains(sortCol)}" th:text="${isAsc ? '↑' : '↓'}"></span>
                </a>
            </th>

            <th data-column-id="email" class="js-column-cell"
                th:with="sortCol='email',
                         currSort=${param.sort != null ? param.sort[0] : ''},
                         isAsc=${currSort.contains(sortCol + ',asc')},
                         newDir=${isAsc ? 'desc' : 'asc'}">
                <a th:href="@{/employees(page=${page.number}, size=${page.size}, q=${currentSearch}, deptId=${currentDeptId}, pos=${currentPos}, sort=${sortCol + ',' + newDir})}"
                   class="text-white text-decoration-none d-block">
                    Email <span th:if="${currSort.contains(sortCol)}" th:text="${isAsc ? '↑' : '↓'}"></span>
                </a>
            </th>

            <th data-column-id="position" class="js-column-cell"
                th:with="sortCol='position',
                         currSort=${param.sort != null ? param.sort[0] : ''},
                         isAsc=${currSort.contains(sortCol + ',asc')},
                         newDir=${isAsc ? 'desc' : 'asc'}">
                <a th:href="@{/employees(page=${page.number}, size=${page.size}, q=${currentSearch}, deptId=${currentDeptId}, pos=${currentPos}, sort=${sortCol + ',' + newDir})}"
                   class="text-white text-decoration-none d-block">
                    Position <span th:if="${currSort.contains(sortCol)}" th:text="${isAsc ? '↑' : '↓'}"></span>
                </a>
            </th>

            <th data-column-id="salary" class="js-column-cell"
                th:with="sortCol='salary',
                         currSort=${param.sort != null ? param.sort[0] : ''},
                         isAsc=${currSort.contains(sortCol + ',asc')},
                         newDir=${isAsc ? 'desc' : 'asc'}">
                <a th:href="@{/employees(page=${page.number}, size=${page.size}, q=${currentSearch}, deptId=${currentDeptId}, pos=${currentPos}, sort=${sortCol + ',' + newDir})}"
                   class="text-white text-decoration-none d-block">
                    Salary <span th:if="${currSort.contains(sortCol)}" th:text="${isAsc ? '↑' : '↓'}"></span>
                </a>
            </th>

            <th data-column-id="department" class="js-column-cell"
                th:with="sortCol='department',
                         currSort=${param.sort != null ? param.sort[0] : ''},
                         isAsc=${currSort.contains(sortCol + ',asc')},
                         newDir=${isAsc ? 'desc' : 'asc'}">
                <a th:href="@{/employees(page=${page.number}, size=${page.size}, q=${currentSearch}, deptId=${currentDeptId}, pos=${currentPos}, sort=${sortCol + ',' + newDir})}"
                   class="text-white text-decoration-none d-block">
                    Department <span th:if="${currSort.contains(sortCol)}" th:text="${isAsc ? '↑' : '↓'}"></span>
                </a>
            </th>

            <th data-column-id="hireDate" class="js-column-cell"
                th:with="sortCol='hireDate',
                         currSort=${param.sort != null ? param.sort[0] : ''},
                         isAsc=${currSort.contains(sortCol + ',asc')},
                         newDir=${isAsc ? 'desc' : 'asc'}">
                <a th:href="@{/employees(page=${page.number}, size=${page.size}, q=${currentSearch}, deptId=${currentDeptId}, pos=${currentPos}, sort=${sortCol + ',' + newDir})}"
                   class="text-white text-decoration-none d-block">
                    Hire Date <span th:if="${currSort.contains(sortCol)}" th:text="${isAsc ? '↑' : '↓'}"></span>
                </a>
            </th>

            <th>Actions</th>
        </tr>
        </thead>

        <tbody>
        <tr th:each="employee : ${employees}">
            <td data-column-id="lastName" class="js-column-cell" th:text="${employee.lastName}"></td>
            <td data-column-id="firstName" class="js-column-cell" th:text="${employee.firstName}"></td>
            <td data-column-id="email" class="js-column-cell" th:text="${employee.email}"></td>
            <td data-column-id="position" class="js-column-cell">
                <span class="badge bg-secondary" th:text="${employee.position}"></span>
            </td>
            <td data-column-id="salary" class="js-column-cell" th:text="${#numbers.formatDecimal(employee.salary, 1, 2)}"></td>

            <td data-column-id="department" class="js-column-cell">
                <span th:if="${employee.department != null}" th:text="${employee.department.name}"></span>
                <span th:unless="${employee.department != null}" class="text-muted">-</span>
            </td>

            <td data-column-id="hireDate" class="js-column-cell"
                th:text="${#temporals.format(employee.hireDate, 'dd.MM.yyyy')}"></td>

            <td class="d-flex gap-2">
                <div th:if="${param.mode != null and param.mode[0] == 'select'}">
                    <a th:href="@{/absences/add(employeeId=${employee.id})}"
                       class="btn btn-success btn-sm">Select</a>
                </div>

                <div th:unless="${param.mode != null and param.mode[0] == 'select'}" class="d-flex gap-2">
                    <a th:href="@{/employees/update(employeeId=${employee.id})}"
                       class="btn btn-info btn-sm">Update</a>

                    <a th:href="@{/employees/delete(employeeId=${employee.id})}"
                       class="btn btn-danger btn-sm"
                       onclick="return confirm('Are you sure you want to delete this employee?')">Delete</a>

                    <a th:href="@{/employees/{id}(id=${employee.id})}"
                       class="btn btn-outline-primary btn-sm">View</a>
                </div>
            </td>
        </tr>
        <tr th:if="${page.empty}">
            <td colspan="8" class="text-center text-muted">No employees found.</td>
        </tr>
        </tbody>
    </table>

    <div class="d-flex flex-wrap align-items-center justify-content-between gap-2 mb-3">
        <div class="btn-group" role="group">
            <a th:if="${page.hasPrevious()}" class="btn btn-outline-secondary btn-sm"
               th:href="@{/employees(page=${page.number - 1}, size=${page.size}, q=${currentSearch}, deptId=${currentDeptId}, pos=${currentPos}, sort=${param.sort != null ? param.sort[0] : ''})}">Previous</a>
            <span th:unless="${page.hasPrevious()}" class="btn btn-outline-secondary btn-sm disabled">Previous</span>

            <a th:if="${page.hasNext()}" class="btn btn-outline-secondary btn-sm"
               th:href="@{/employees(page=${page.number + 1}, size=${page.size}, q=${currentSearch}, deptId=${currentDeptId}, pos=${currentPos}, sort=${param.sort != null ? param.sort[0] : ''})}">Next</a>
            <span th:unless="${page.hasNext()}" class="btn btn-outline-secondary btn-sm disabled">Next</span>
        </div>

        <div>
            Page <span th:text="${page.number + 1}"></span> of <span th:text="${page.totalPages == 0 ? 1 : page.totalPages}"></span>
        </div>

        <form th:action="@{/employees}" method="get" class="d-flex align-items-center gap-2">
            <input type="hidden" name="page" value="0">
            <input type="hidden" name="q" th:value="${currentSearch}">
            <input type="hidden" name="deptId" th:value="${currentDeptId}">
            <input type="hidden" name="pos" th:value="${currentPos}">
            <input type="hidden" name="sort" th:if="${param.sort != null}" th:value="${param.sort[0]}">

            <label class="mb-0 small">Rows:</label>
            <select name="size" class="form-select form-select-sm" style="width: auto;" onchange="this.form.submit()">
                <option th:value="10" th:selected="${page.size == 10}">10</option>
                <option th:value="20" th:selected="${page.size == 20}">20</option>
                <option th:value="50" th:selected="${page.size == 50}">50</option>
            </select>
        </form>
    </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js"></script>
<script>
    (function () {
        const STORAGE_KEY = 'employeeTableCols';

        function applyVisibility() {
            document.querySelectorAll('.js-column-toggle').forEach(cb => {
                const colId = cb.value;
                const isVisible = cb.checked;
                document.querySelectorAll(`.js-column-cell[data-column-id="${colId}"]`).forEach(cell => {
                    if (isVisible) cell.classList.remove('table-column-hidden');
                    else cell.classList.add('table-column-hidden');
                });
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            // 1. Відновити стан
            const stored = localStorage.getItem(STORAGE_KEY);
            if (stored) {
                try {
                    const checkedValues = JSON.parse(stored);
                    document.querySelectorAll('.js-column-toggle').forEach(cb => {
                        if (cb.value !== 'lastName') { // lastName завжди on
                            cb.checked = checkedValues.includes(cb.value);
                        }
                    });
                } catch(e) {}
            }
            // 2. Застосувати
            applyVisibility();

            // 3. Слухати зміни
            document.querySelectorAll('.js-column-toggle').forEach(cb => {
                cb.addEventListener('change', () => {
                    applyVisibility();
                    const checked = Array.from(document.querySelectorAll('.js-column-toggle:checked')).map(c => c.value);
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(checked));
                });
            });
        });
    })();
</script>
</body>
</html>